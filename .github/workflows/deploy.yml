name: Deploy Eventura Seguro

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Pegar o código
      - name: Checkout do código
        uses: actions/checkout@v3

      # 2. Verificar estrutura do projeto
      - name: Verificar estrutura
        run: |
          echo "Estrutura do projeto:"
          ls -la
          echo ""
          echo "Arquivos principais:"
          find . -maxdepth 2 -type f -name "*.json" -o -name "*.yml" -o -name "*.yaml" -o -name "Dockerfile*" | sort

      # 3. Testar conexão SSH primeiro
      - name: Testar conexão SSH
        uses: appleboy/ssh-action@v1.0.0 # Versão mais recente
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "✅ Conexão SSH bem-sucedida"
            echo "Usuário: $(whoami)"
            echo "Diretório atual: $(pwd)"
            echo "Criando diretório de destino..."
            mkdir -p /home/eventura/eventura
            chmod 755 /home/eventura/eventura
            echo "Diretório criado/verificado"
            ls -ld /home/eventura/eventura

      # 4. Gerar tarball
      - name: Gerar tarball seguro
        run: |
          echo "Criando tarball..."
          # Lista de arquivos/diretórios para excluir
          EXCLUDE_PATTERNS=".git node_modules *.log build dist .env"

          # Método mais seguro
          find . -type f \( \
            -name "*.ts" -o \
            -name "*.js" -o \
            -name "*.json" -o \
            -name "*.yml" -o \
            -name "*.yaml" -o \
            -name "Dockerfile*" -o \
            -name "docker-compose*" -o \
            -name "*.tsx" -o \
            -name "*.jsx" -o \
            -name "*.css" -o \
            -name "*.html" \
          \) | grep -v node_modules | grep -v .git > files.txt

          # Adicionar diretórios estruturais importantes
          if [ -d "backend" ]; then
            find backend -type f -name "*" | grep -v node_modules >> files.txt
          fi

          if [ -d "frontend" ]; then
            find frontend -type f -name "*" | grep -v node_modules >> files.txt
          fi

          echo "Criando tarball com $(wc -l < files.txt) arquivos..."
          tar -czf deploy.tar.gz -T files.txt --warning=no-file-removed

          echo "✅ Tarball criado:"
          ls -lh deploy.tar.gz
          echo ""
          echo "Conteúdo (primeiros 20):"
          tar -tzf deploy.tar.gz | head -20

      # 5. Copiar para servidor (versão simplificada)
      - name: Copiar tarball para servidor
        run: |
          echo "Configurando chave SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "Testando conexão SCP..."
          scp -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              deploy.tar.gz \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/eventura/deploy.tar.gz

          echo "✅ Arquivo copiado com sucesso!"

      # 6. Executar deploy remoto
      - name: Executar deploy no servidor
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "=== INICIANDO DEPLOY ==="
            cd /home/eventura

            # Verificar se arquivo existe
            if [ ! -f "deploy.tar.gz" ]; then
              echo "❌ Erro: deploy.tar.gz não encontrado!"
              exit 1
            fi

            echo "1. Criando backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="backups/backup_$TIMESTAMP"
            mkdir -p "$BACKUP_DIR"

            if [ -d "eventura/backend" ]; then
              cp -r eventura/backend "$BACKUP_DIR/" 2>/dev/null || true
            fi
            if [ -d "eventura/frontend" ]; then
              cp -r eventura/frontend "$BACKUP_DIR/" 2>/dev/null || true
            fi
            if [ -f "eventura/docker-compose.yml" ]; then
              cp eventura/docker-compose.yml "$BACKUP_DIR/" 2>/dev/null || true
            fi

            echo "2. Limpando diretório atual..."
            rm -rf eventura/* 2>/dev/null || true
            mkdir -p eventura

            echo "3. Extraindo novo código..."
            tar -xzf deploy.tar.gz -C eventura/
            rm -f deploy.tar.gz

            echo "4. Verificando estrutura extraída..."
            cd eventura
            ls -la

            echo "5. Garantindo arquivos .env..."
            # Backend .env
            if [ ! -f "backend/.env" ]; then
              echo "Criando backend/.env..."
              mkdir -p backend
              cat > backend/.env << 'EOF'
            DATABASE_URL="postgresql://eventura:password@db:5432/eventura_db"
            NODE_ENV=production
            PORT=3001
            JWT_SECRET=your-secret-key-change-this
            EOF
            fi

            # Frontend .env
            if [ ! -f "frontend/.env" ]; then
              echo "Criando frontend/.env..."
              mkdir -p frontend
              cat > frontend/.env << 'EOF'
            REACT_APP_API_URL=http://localhost:3001
            NODE_ENV=production
            EOF
            fi

            echo "6. Verificando Docker..."
            docker --version
            docker compose version

            echo "7. Parando containers antigos..."
            docker compose down --remove-orphans || true

            echo "8. Construindo novos containers..."
            docker compose build --no-cache

            echo "9. Iniciando containers..."
            docker compose up -d

            echo "10. Aguardando inicialização..."
            sleep 15

            echo "11. Verificando status..."
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            echo "12. Verificando logs..."
            docker compose logs --tail=20

            echo "✅ DEPLOY CONCLUÍDO COM SUCESSO!"
