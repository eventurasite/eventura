name: Deploy Eventura Seguro

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Pegar o código
      - name: Checkout do código
        uses: actions/checkout@v3

      # 2. Gerar tarball excluindo arquivos pesados e desnecessários
      - name: Gerar tarball seguro
        run: |
          echo "Criando tarball excluindo .git, node_modules e logs..."
          # Cria uma lista de arquivos para excluir de forma mais robusta
          find . -name '.git' -prune -o \
                 -name 'node_modules' -prune -o \
                 -name '*.log' -prune -o \
                 -type f -print > files-to-include.txt || true

          # Cria o tarball com arquivos listados
          tar -czf deploy.tar.gz --files-from files-to-include.txt 2>/dev/null || echo "Tar completado (alguns warnings possíveis)"

          # Verifica se o tarball foi criado
          if [ -f deploy.tar.gz ]; then
            echo "Tarball criado com sucesso. Tamanho: $(du -h deploy.tar.gz | cut -f1)"
          else
            echo "Erro: Tarball não foi criado!"
            exit 1
          fi

      # 3. Copiar tarball para o servidor
      - name: Copiar arquivos para o servidor
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/eventura/eventura"
          rm: false

      # 4. Executar o deploy remoto
      - name: Deploy remoto seguro
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "=== INICIANDO DEPLOY ==="
            cd /home/eventura/eventura

            echo "1. Criando backup da versão anterior..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            if [ -d "backend" ] || [ -d "frontend" ]; then
              mkdir -p backups
              BACKUP_DIR="backups/backup_$TIMESTAMP"
              mkdir -p "$BACKUP_DIR"
              [ -d "backend" ] && mv backend "$BACKUP_DIR/" 2>/dev/null || true
              [ -d "frontend" ] && mv frontend "$BACKUP_DIR/" 2>/dev/null || true
              [ -f "docker-compose.yml" ] && mv docker-compose.yml "$BACKUP_DIR/" 2>/dev/null || true
              echo "Backup criado em: $BACKUP_DIR"
            fi

            echo "2. Extraindo novo código..."
            if [ ! -f "deploy.tar.gz" ]; then
              echo "Erro: deploy.tar.gz não encontrado!"
              exit 1
            fi

            tar -xzf deploy.tar.gz

            echo "3. Limpando arquivo temporário..."
            rm -f deploy.tar.gz

            echo "4. Verificando estrutura do projeto..."
            ls -la

            echo "5. Verificando Docker..."
            # Verifica se o Docker está disponível
            if ! command -v docker &> /dev/null; then
              echo "Erro: Docker não está instalado!"
              exit 1
            fi

            # Verifica se docker-compose está disponível
            if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
              echo "Erro: Docker Compose não está disponível!"
              exit 1
            fi

            echo "6. Verificando e preparando arquivos .env..."
            # Backend .env
            if [ ! -f "backend/.env" ]; then
              echo "Aviso: backend/.env não encontrado. Criando com valores padrão..."
              mkdir -p backend
              cat > backend/.env << EOF
            # Database
            DATABASE_URL="postgresql://user:password@localhost:5432/dbname"

            # App
            NODE_ENV=production
            PORT=3001

            # Security
            JWT_SECRET=change_this_in_production
            EOF
            else
              echo "backend/.env já existe. Mantendo configurações."
            fi

            # Frontend .env
            if [ ! -f "frontend/.env" ]; then
              echo "Aviso: frontend/.env não encontrado. Criando..."
              mkdir -p frontend
              cat > frontend/.env << EOF
            REACT_APP_API_URL=/api
            NODE_ENV=production
            EOF
            else
              echo "frontend/.env já existe. Mantendo configurações."
            fi

            echo "7. Dando permissões necessárias..."
            # Ajusta permissões se necessário
            chmod -R 755 backend frontend 2>/dev/null || true

            echo "8. Verificando se usuário está no grupo docker..."
            if ! groups $USER | grep -q '\bdocker\b'; then
              echo "Adicionando $USER ao grupo docker..."
              sudo usermod -aG docker $USER || echo "Aviso: Não foi possível adicionar ao grupo docker"
              # Aplica mudanças sem precisar logout
              newgrp docker || true
            fi

            echo "9. Parando containers existentes..."
            docker compose down --remove-orphans || true

            echo "10. Construindo e iniciando containers..."
            # Usa docker-compose ou docker compose
            if command -v docker-compose &> /dev/null; then
              docker-compose up -d --build
            else
              docker compose up -d --build
            fi

            echo "11. Verificando status dos containers..."
            sleep 10
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            echo "12. Verificando logs iniciais..."
            docker compose logs --tail=20

            echo "=== DEPLOY CONCLUÍDO COM SUCESSO ==="
