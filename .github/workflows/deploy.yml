name: Deploy Eventura Seguro

on:
  push:
    branches:
      - main
      - test-ci-cd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Criar pacote de deploy
        run: |
          # M√©todo simples e confi√°vel
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='*.tar.gz' \
            backend frontend docker-compose.yml 2>/dev/null || echo "Pacote criado"

          echo "Pacote criado: $(ls -lh deploy.tar.gz)"

      - name: Enviar para servidor
        run: |
          # Configurar SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Testar conex√£o
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "mkdir -p ~/eventura && echo 'OK'"

          # Enviar arquivo
          scp -o StrictHostKeyChecking=no \
              deploy.tar.gz \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/eventura/

      - name: Configurar Docker e executar deploy
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "=== CONFIGURA√á√ÉO INICIAL ==="

            # 1. Adicionar usu√°rio ao grupo docker (se necess√°rio)
            if ! groups $USER | grep -q '\bdocker\b'; then
              echo "üîß Adicionando $USER ao grupo docker..."
              sudo usermod -aG docker $USER
              
              # Aplicar mudan√ßas para a sess√£o atual
              # Nota: Isso pode n√£o funcionar em todas as situa√ß√µes
              # O ideal √© fazer logout/login, mas para o script usamos:
              echo "‚ö†Ô∏è  Usu√°rio adicionado ao grupo docker."
              echo "‚ö†Ô∏è  Pode ser necess√°rio fazer logout/login para efeitos surtirem."
              echo "‚ö†Ô∏è  Tentando continuar..."
            else
              echo "‚úÖ Usu√°rio j√° est√° no grupo docker"
            fi

            # 2. Testar permiss√µes Docker
            echo "Testando acesso ao Docker..."
            if docker info > /dev/null 2>&1; then
              echo "‚úÖ Acesso ao Docker OK"
            else
              echo "‚ùå Sem acesso ao Docker. Tentando solu√ß√µes..."
              
              # Tentar com sudo
              if sudo docker info > /dev/null 2>&1; then
                echo "‚úÖ Docker funciona com sudo"
                # Definir alias para usar sudo com docker
                alias docker="sudo docker"
                alias docker-compose="sudo docker-compose"
              else
                echo "‚ùå Docker n√£o est√° rodando ou sem permiss√µes"
                echo "Iniciando Docker..."
                sudo systemctl start docker || true
                sudo systemctl enable docker || true
                sleep 3
              fi
            fi

            # 3. Ir para diret√≥rio do projeto
            cd ~/eventura

            echo "=== INICIANDO DEPLOY ==="

            # 4. Verificar e extrair arquivo
            if [ ! -f "deploy.tar.gz" ]; then
              echo "‚ùå Erro: deploy.tar.gz n√£o encontrado!"
              ls -la
              exit 1
            fi

            tar -xzf deploy.tar.gz
            rm -f deploy.tar.gz

            # 5. Remover atributo 'version' obsoleto do docker-compose.yml
            echo "Corrigindo docker-compose.yml..."
            if [ -f "docker-compose.yml" ]; then
              # Remover a linha 'version' se existir
              grep -v '^version:' docker-compose.yml > docker-compose-temp.yml
              mv docker-compose-temp.yml docker-compose.yml
              echo "‚úÖ docker-compose.yml corrigido"
            fi

            # 6. Verificar se podemos executar docker
            echo "Verificando Docker Compose..."
            DOCKER_CMD="docker"
            COMPOSE_CMD="docker compose"

            # Se n√£o tem permiss√£o, usa sudo
            if ! $DOCKER_CMD info > /dev/null 2>&1; then
              echo "Usando sudo para comandos Docker..."
              DOCKER_CMD="sudo docker"
              COMPOSE_CMD="sudo docker compose"
            fi

            # 7. Parar containers antigos
            echo "Parando containers antigos..."
            $COMPOSE_CMD down --remove-orphans 2>/dev/null || true

            # 8. Construir e iniciar
            echo "Construindo containers..."
            $COMPOSE_CMD build --no-cache

            echo "Iniciando containers..."
            $COMPOSE_CMD up -d

            # 9. Verificar status
            echo "Aguardando inicializa√ß√£o..."
            sleep 15

            echo "Status dos containers:"
            $DOCKER_CMD ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # 10. Verificar logs
            echo "√öltimos logs:"
            $COMPOSE_CMD logs --tail=30 || echo "N√£o foi poss√≠vel obter logs"

            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
