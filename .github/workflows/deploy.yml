name: Deploy Eventura Seguro

on:
  push:
    branches:
      - main
      - test-ci-cd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Pegar o código
      - name: Checkout do código
        uses: actions/checkout@v3

      # 2. Testar conexão SSH primeiro
      - name: Testar conexão SSH e descobrir diretório
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "✅ Conexão SSH bem-sucedida"
            echo "Usuário: $(whoami)"
            echo "Diretório home: $HOME"
            echo "Diretório atual: $(pwd)"

            # Verificar se temos permissão de escrita
            echo "Testando permissões..."
            TEST_DIR="$HOME/eventura"
            mkdir -p "$TEST_DIR"
            echo "Diretório criado em: $TEST_DIR"
            ls -ld "$TEST_DIR"
            echo "Espaço disponível:"
            df -h "$HOME"

      # 3. Gerar tarball
      - name: Gerar tarball seguro
        run: |
          echo "Criando tarball..."

          # Método simplificado e confiável
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='*.log' \
              --exclude='build' \
              --exclude='dist' \
              --exclude='.env' \
              -czf deploy.tar.gz . 2>/dev/null || true

          echo "✅ Tarball criado: $(ls -lh deploy.tar.gz)"
          echo "Conteúdo (primeiros 10):"
          tar -tzf deploy.tar.gz | head -10

      # 4. Copiar para servidor usando diretório do usuário
      - name: Copiar arquivos para o servidor
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "~/eventura" # Usar diretório home do usuário
          overwrite: true

      # 5. Executar deploy remoto
      - name: Deploy remoto
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "=== INICIANDO DEPLOY ==="
            cd ~/eventura

            echo "1. Verificando arquivo..."
            if [ ! -f "deploy.tar.gz" ]; then
              echo "❌ Erro: deploy.tar.gz não encontrado!"
              ls -la
              exit 1
            fi

            echo "2. Extraindo código..."
            tar -xzf deploy.tar.gz
            rm -f deploy.tar.gz

            echo "3. Verificando estrutura..."
            ls -la

            echo "4. Garantindo arquivos .env..."
            # Backend .env (se não existir)
            if [ ! -f "backend/.env" ]; then
              echo "Criando backend/.env..."
              mkdir -p backend
              cat > backend/.env << 'EOF'
            DATABASE_URL="postgresql://eventura:password@db:5432/eventura_db"
            NODE_ENV=production
            PORT=3001
            JWT_SECRET=your-secret-key-change-this
            EOF
            fi

            # Frontend .env (se não existir)
            if [ ! -f "frontend/.env" ]; then
              echo "Criando frontend/.env..."
              mkdir -p frontend
              cat > frontend/.env << 'EOF'
            REACT_APP_API_URL=http://localhost:3001
            NODE_ENV=production
            EOF
            fi

            echo "5. Verificando Docker..."
            docker --version || echo "Docker não encontrado"
            docker compose version || echo "Docker Compose não encontrado"

            echo "6. Parando containers antigos (se existirem)..."
            if [ -f "docker-compose.yml" ]; then
              docker compose down --remove-orphans || true
            else
              echo "Aviso: docker-compose.yml não encontrado"
            fi

            echo "7. Construindo e iniciando containers..."
            if [ -f "docker-compose.yml" ]; then
              docker compose build --no-cache
              docker compose up -d
              
              echo "8. Aguardando inicialização..."
              sleep 10
              
              echo "9. Verificando status..."
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
              
              echo "10. Verificando logs..."
              docker compose logs --tail=20 || true
            else
              echo "⚠️  Aviso: Não foi possível executar docker-compose"
              echo "Estrutura atual:"
              find . -type f -name "*.yml" -o -name "*.yaml" -o -name "Dockerfile*" | head -20
            fi

            echo "✅ DEPLOY COMPLETO!"
