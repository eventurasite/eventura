name: Deploy Eventura
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Criar pacote de deploy
        run: |
          mkdir deploy
          cp -r backend frontend docker-compose.yml deploy/

          # garantir .env (não falha se não existir)
          mkdir -p deploy/backend deploy/frontend
          cp backend/.env deploy/backend/.env || true
          cp frontend/.env deploy/frontend/.env || true

          tar -czf deploy.tar.gz deploy

      - name: Enviar pacote ao servidor
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/esof/projetosiftm/eventura"

      - name: Descompactar e rodar Docker
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/esof/projetosiftm/eventura

            # recriar pasta do projeto
            rm -rf eventura
            mkdir eventura

            mv deploy.tar.gz eventura/
            cd eventura

            tar -xzf deploy.tar.gz

            # mover conteúdo para raiz (backend, frontend, docker-compose.yml)
            mv deploy/* .
            rm -rf deploy deploy.tar.gz

            # garantir permissão do docker (importante!)
            sudo usermod -aG docker $USER || true

            # subir containers (sempre daqui)
            docker compose down || true
            docker compose up -d --build
