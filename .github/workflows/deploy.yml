name: Deploy Eventura Seguro

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Criar pacote
        run: |
          echo "Criando pacote..."
          tar -czf deploy.tar.gz \
            backend/ \
            frontend/ \
            docker-compose.yml \
            Dockerfile* \
            2>/dev/null || tar -czf deploy.tar.gz backend/ frontend/ docker-compose.yml
          
          echo "Pacote: $(ls -lh deploy.tar.gz)"

      - name: Enviar para servidor
        run: |
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              deploy.tar.gz \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/eventura/

      - name: Iniciar Docker e fazer deploy
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            
            echo "=== INICIANDO DOCKER ==="
            
            # 1. Verificar status do Docker
            echo "Verificando Docker..."
            if sudo systemctl is-active docker > /dev/null 2>&1; then
              echo "✅ Docker já está rodando"
            else
              echo "⚠️  Docker não está rodando. Iniciando..."
              
              # Tentar iniciar
              sudo systemctl start docker
              sleep 5
              
              # Verificar se iniciou
              if sudo systemctl is-active docker > /dev/null 2>&1; then
                echo "✅ Docker iniciado com sucesso"
              else
                echo "❌ Falha ao iniciar Docker. Tentando instalar..."
                
                # Tentar instalar Docker se não existir
                if ! command -v docker &> /dev/null; then
                  echo "Instalando Docker..."
                  sudo apt-get update
                  sudo apt-get install -y docker.io docker-compose
                fi
                
                # Iniciar e habilitar
                sudo systemctl start docker
                sudo systemctl enable docker
                sleep 3
              fi
            fi
            
            # 2. Verificar se Docker está realmente funcionando
            echo "Testando Docker..."
            if sudo docker info > /dev/null 2>&1; then
              echo "✅ Docker funcionando"
            else
              echo "❌ Docker ainda não está funcionando"
              echo "Tentando solução alternativa..."
              
              # Forçar reinício
              sudo systemctl daemon-reload
              sudo systemctl restart docker.socket
              sudo systemctl restart docker
              sleep 5
            fi
            
            echo "=== PREPARANDO DEPLOY ==="
            cd ~/eventura
            
            # 3. Verificar arquivo
            if [ ! -f "deploy.tar.gz" ]; then
              echo "❌ deploy.tar.gz não encontrado!"
              ls -la
              exit 1
            fi
            
            # 4. Extrair
            echo "Extraindo..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            # 5. Verificar estrutura
            echo "Conteúdo extraído:"
            ls -la
            
            # 6. Corrigir docker-compose se necessário
            if [ -f "docker-compose.yml" ]; then
              echo "Verificando docker-compose.yml..."
              # Remover versão obsoleta
              sed -i '/^version:/d' docker-compose.yml 2>/dev/null || true
            else
              echo "❌ docker-compose.yml não encontrado!"
              exit 1
            fi
            
            # 7. Garantir permissões Docker para o usuário
            echo "Configurando permissões Docker..."
            if ! groups $USER | grep -q '\bdocker\b'; then
              echo "Adicionando $USER ao grupo docker..."
              sudo usermod -aG docker $USER
            fi
            
            # Corrigir permissões do socket
            sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
            
            echo "=== EXECUTANDO DOCKER COMPOSE ==="
            
            # 8. Parar containers antigos (se existirem)
            echo "Parando containers antigos..."
            sudo docker compose down --remove-orphans 2>/dev/null || true
            
            # 9. Construir containers
            echo "Construindo containers..."
            sudo docker compose build --no-cache
            
            # 10. Iniciar containers
            echo "Iniciando containers..."
            sudo docker compose up -d
            
            # 11. Verificar
            echo "Aguardando inicialização..."
            sleep 30
            
            echo "=== VERIFICAÇÃO FINAL ==="
            
            echo "1. Status Docker:"
            sudo systemctl status docker --no-pager | head -10
            
            echo ""
            echo "2. Todos os containers:"
            sudo docker ps -a
            
            echo ""
            echo "3. Containers em execução:"
            sudo docker ps
            
            echo ""
            echo "4. Logs dos últimos 30 segundos:"
            timeout 5 sudo docker compose logs --since=30s || echo "Não foi possível obter logs"
            
            echo ""
            echo "5. Verificar portas:"
            sudo docker port $(sudo docker ps -q --filter "name=backend" 2>/dev/null | head -1) 2>/dev/null || echo "Backend não encontrado"
            sudo docker port $(sudo docker ps -q --filter "name=frontend" 2>/dev/null | head -1) 2>/dev/null || echo "Frontend não encontrado"
            
            echo "✅ DEPLOY COMPLETO!"